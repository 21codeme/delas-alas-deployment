<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Delas Alas Dental Clinic</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .reports-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .page-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-5px);
        }

        .chart-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .chart-header i {
            font-size: 24px;
            color: #667eea;
        }

        .chart-header h2 {
            color: #333;
            font-size: 1.5em;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-box i {
            font-size: 36px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .stat-box h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-box .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="reports-container">
        <div class="page-header">
            <h1>
                <i class="fas fa-chart-bar"></i>
                Reports & Analytics
            </h1>
            <p>View insights about services and monthly appointments</p>
        </div>

        <div class="stats-summary" id="statsSummary">
            <div class="stat-box">
                <i class="fas fa-calendar-check"></i>
                <h3>Total Appointments</h3>
                <div class="value" id="totalAppointments">0</div>
            </div>
            <div class="stat-box">
                <i class="fas fa-tools"></i>
                <h3>Services Offered</h3>
                <div class="value" id="totalServices">0</div>
            </div>
            <div class="stat-box">
                <i class="fas fa-check-circle"></i>
                <h3>Confirmed</h3>
                <div class="value" id="confirmedCount">0</div>
            </div>
            <div class="stat-box">
                <i class="fas fa-clock"></i>
                <h3>Pending</h3>
                <div class="value" id="pendingCount">0</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <i class="fas fa-chart-pie"></i>
                    <h2>Most Popular Services</h2>
                </div>
                <div id="servicesChartLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading services data...</p>
                </div>
                <div class="chart-container" style="display: none;">
                    <canvas id="servicesChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <i class="fas fa-chart-bar"></i>
                    <h2>Daily Appointments</h2>
                    <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                        <label for="monthSelector" style="font-size: 14px; color: #666;">Month:</label>
                        <input type="month" id="monthSelector" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;" onchange="updateDailyChart()">
                    </div>
                </div>
                <div id="monthlyChartLoading" class="loading">
                    <div class="spinner"></div>
                    <p>Loading daily data...</p>
                </div>
                <div class="chart-container" style="display: none;">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://xlubjwiumytdkxrzojdg.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhsdWJqd2l1bXl0ZGt4cnpvamRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MTQ2MDAsImV4cCI6MjA3NjI5MDYwMH0.RYal1H6Ibre86bHyMIAmc65WCLt1x0j9p_hbEWdBXnQ';

        // Function to call Supabase API
        async function callSupabaseAPI(method, endpoint, body = null) {
            const headers = {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            };

            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, options);
            const contentType = response.headers.get('content-type') || '';
            const text = await response.text();
            const data = contentType.includes('application/json') && text ? JSON.parse(text) : (text ? { message: text } : []);
            if (!response.ok) throw new Error(data.message || data.msg || `HTTP ${response.status}`);
            return data;
        }

        // Global variables for charts
        let servicesChart = null;
        let monthlyChart = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadReportsData();
        });

        // Store appointments globally for chart regeneration
        let allAppointments = [];

        // Load all reports data
        async function loadReportsData() {
            try {
                console.log('üìä Loading reports data...');
                
                // Load appointments from database
                allAppointments = await callSupabaseAPI('GET', 'appointments?select=id,service_type,appointment_date,status');
                
                if (!Array.isArray(allAppointments) || allAppointments.length === 0) {
                    showError('No appointment data found.');
                    return;
                }

                console.log('‚úÖ Loaded', allAppointments.length, 'appointments');

                // Update stats summary
                updateStatsSummary(allAppointments);

                // Generate services pie chart
                generateServicesChart(allAppointments);

                // Generate daily bar chart for selected month
                generateMonthlyChart(allAppointments);

            } catch (error) {
                console.error('‚ùå Error loading reports data:', error);
                showError('Failed to load reports data. Please try again later.');
            }
        }

        // Update daily chart when month selector changes
        function updateDailyChart() {
            if (allAppointments && allAppointments.length > 0) {
                generateMonthlyChart(allAppointments);
            } else {
                loadReportsData();
            }
        }

        // Update stats summary
        function updateStatsSummary(appointments) {
            const total = appointments.length;
            const services = new Set(appointments.map(apt => apt.service_type).filter(Boolean));
            const confirmed = appointments.filter(apt => apt.status === 'confirmed').length;
            const pending = appointments.filter(apt => apt.status === 'pending').length;

            document.getElementById('totalAppointments').textContent = total;
            document.getElementById('totalServices').textContent = services.size;
            document.getElementById('confirmedCount').textContent = confirmed;
            document.getElementById('pendingCount').textContent = pending;
        }

        // Generate services pie chart
        function generateServicesChart(appointments) {
            try {
                // Count services
                const serviceCounts = {};
                appointments.forEach(apt => {
                    const service = apt.service_type || 'General Consultation';
                    serviceCounts[service] = (serviceCounts[service] || 0) + 1;
                });

                // Sort by count and get top services
                const sortedServices = Object.entries(serviceCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10); // Top 10 services

                const labels = sortedServices.map(([service]) => service);
                const data = sortedServices.map(([, count]) => count);

                // Color palette
                const colors = [
                    '#667eea', '#764ba2', '#f093fb', '#f5576c',
                    '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                    '#fa709a', '#fee140', '#30cfd0', '#330867'
                ];

                // Hide loading, show chart
                document.getElementById('servicesChartLoading').style.display = 'none';
                document.querySelector('#servicesChart').parentElement.style.display = 'block';

                // Destroy existing chart if it exists
                if (servicesChart) {
                    servicesChart.destroy();
                }

                // Create pie chart
                const ctx = document.getElementById('servicesChart').getContext('2d');
                servicesChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                console.log('‚úÖ Services chart generated');
            } catch (error) {
                console.error('‚ùå Error generating services chart:', error);
                document.getElementById('servicesChartLoading').innerHTML = 
                    '<div class="error-message">Error loading services chart</div>';
            }
        }

        // Generate daily appointments bar chart for selected month
        function generateMonthlyChart(appointments) {
            try {
                // Get selected month or use current month
                const monthSelector = document.getElementById('monthSelector');
                let selectedMonth = monthSelector ? monthSelector.value : '';
                
                // If no month selected, use current month
                if (!selectedMonth) {
                    const now = new Date();
                    selectedMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                    if (monthSelector) {
                        monthSelector.value = selectedMonth;
                    }
                }

                const [year, month] = selectedMonth.split('-').map(Number);
                
                // Get first and last day of the month
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);
                const daysInMonth = lastDay.getDate();
                
                // Initialize daily data for all days in the month
                const dailyData = {};
                for (let day = 1; day <= daysInMonth; day++) {
                    dailyData[day] = 0;
                }
                
                // Count appointments per day in the selected month
                appointments.forEach(apt => {
                    if (!apt.appointment_date) return;
                    
                    const aptDate = new Date(apt.appointment_date);
                    const aptYear = aptDate.getFullYear();
                    const aptMonth = aptDate.getMonth() + 1;
                    const aptDay = aptDate.getDate();
                    
                    // Check if appointment is in the selected month
                    if (aptYear === year && aptMonth === month) {
                        dailyData[aptDay] = (dailyData[aptDay] || 0) + 1;
                    }
                });

                // Create labels and data arrays
                const labels = [];
                const data = [];
                
                for (let day = 1; day <= daysInMonth; day++) {
                    labels.push(day);
                    data.push(dailyData[day] || 0);
                }

                // Format month name for display
                const monthName = firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // Hide loading, show chart
                document.getElementById('monthlyChartLoading').style.display = 'none';
                document.querySelector('#monthlyChart').parentElement.style.display = 'block';

                // Destroy existing chart if it exists
                if (monthlyChart) {
                    monthlyChart.destroy();
                }

                // Create bar chart
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                monthlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Appointments',
                            data: data,
                            backgroundColor: function(context) {
                                const value = context.parsed.y;
                                // Different colors based on appointment count
                                if (value === 0) return 'rgba(200, 200, 200, 0.3)';
                                if (value <= 2) return 'rgba(102, 126, 234, 0.6)';
                                if (value <= 5) return 'rgba(102, 126, 234, 0.8)';
                                return 'rgba(102, 126, 234, 1)';
                            },
                            borderColor: '#667eea',
                            borderWidth: 1,
                            borderRadius: 4,
                            borderSkipped: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: `Appointments per Day - ${monthName}`,
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                padding: {
                                    bottom: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const day = context[0].label;
                                        const date = new Date(year, month - 1, day);
                                        return date.toLocaleDateString('en-US', { 
                                            weekday: 'long', 
                                            month: 'short', 
                                            day: 'numeric' 
                                        });
                                    },
                                    label: function(context) {
                                        const count = context.parsed.y;
                                        return `Appointments: ${count}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Appointments',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Day of Month',
                                    font: {
                                        size: 12
                                    }
                                },
                                ticks: {
                                    maxRotation: 0,
                                    autoSkip: false,
                                    callback: function(value, index) {
                                        // Show every 5th day or last day
                                        const day = parseInt(value);
                                        if (day % 5 === 0 || day === labels.length) {
                                            return day;
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    }
                });

                console.log(`‚úÖ Daily chart generated for ${monthName}`);
            } catch (error) {
                console.error('‚ùå Error generating monthly chart:', error);
                document.getElementById('monthlyChartLoading').innerHTML = 
                    '<div class="error-message">Error loading monthly chart</div>';
            }
        }

        // Show error message
        function showError(message) {
            const container = document.querySelector('.reports-container');
            container.innerHTML = `
                <div class="page-header">
                    <h1><i class="fas fa-exclamation-triangle"></i> Error</h1>
                </div>
                <div class="error-message">
                    ${message}
                </div>
            `;
        }
    </script>
</body>
</html>

